<!DOCTYPE html>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:20px}
.container{display:flex;flex-direction:column;gap:15px}
.upload-row{display:flex;gap:15px}
.upload-box{flex:1;border:2px dashed #ccc;padding:15px;text-align:center;min-height:100px;display:flex;flex-direction:column;justify-content:center;position:relative;transition:all 0.3s}
.upload-box.compact{padding:10px;min-height:80px}
.upload-box h3{margin:0 0 8px;font-size:16px}
.upload-box.compact h3{font-size:14px;margin:0 0 5px}
.upload-box.active{border-color:#0052cc;background:#f0f7ff}
.upload-box.inactive{opacity:0.5;filter:grayscale(50%)}
input[type="file"]{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer}
.btn{background:#0052cc;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;margin:3px;font-size:13px}
.btn:disabled{background:#ccc}
.btn-secondary{background:#6c757d}
.error{color:#d00;background:#fee;padding:8px;border-radius:4px;display:none}
.editor{display:none;border:1px solid #ddd;border-radius:4px}
.editor-header{display:grid;grid-template-columns:1fr 1fr;background:#f5f5f5;padding:8px;border-bottom:1px solid #ddd;font-size:13px}
.translation-list{}
.translation-item{display:grid;grid-template-columns:1fr 1fr;padding:10px;border-bottom:1px solid #eee;gap:10px;align-items:start}
.translation-item:nth-child(even){background:#fafafa}
.source-area{position:relative}
.source-text{padding:6px;border-left:3px solid #0052cc;background:#f0f7ff;border-radius:4px;white-space:pre-wrap;word-break:break-word;transition:border-color 0.2s;font-size:13px}
.source-text.changed{border-left-color:#ff9800 !important;background:#fff8e1}
.source-input{width:100%;padding:6px;border:1px solid #b3d4ff;border-radius:4px;resize:vertical;font-family:inherit;min-height:35px;box-sizing:border-box;font-size:13px}
.source-input.changed{border-color:#ff9800 !important;background:#fff8e1}
.lock-btn{position:absolute;top:6px;right:6px;background:none;border:none;cursor:pointer;font-size:12px;opacity:0.5;z-index:10;padding:2px}
.lock-btn:hover{opacity:1}
.translation-input{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;resize:vertical;font-family:inherit;min-height:35px;transition:border-color 0.2s, background-color 0.2s;font-size:13px}
.translation-input:focus{outline:none;border-color:#0052cc;box-shadow:0 0 0 2px rgba(0,82,204,0.1)}
.translation-input.changed{border-color:#ff9800 !important;background:#fff8e1}
.key-path{font-family:monospace;font-size:11px;color:#666;padding:4px 0 0 0;margin-top:4px;border-top:1px dashed #ddd}
.array-indicator{color:#28a745;font-size:10px;margin-left:4px;background:#e8f5e9;padding:1px 4px;border-radius:8px}
.action-buttons{display:flex;gap:8px;justify-content:center;margin:15px 0;padding-top:15px;border-top:1px solid #e9ecef}
.status{text-align:center;padding:15px;color:#666}
.file-info{font-size:11px;color:#666;margin-top:5px}
.upload-box.compact .file-info{font-size:10px}
.control-buttons{display:flex;gap:8px;justify-content:center;align-items:center;margin:10px 0}
</style>
<div class="container">
<div class="upload-row">
<div class="upload-box" id="sourceBox">
<h3>Source JSON</h3>
<div>Click or drop JSON file</div>
<input type="file" id="sourceFile" accept=".json,application/json">
<div class="file-info" id="sourceInfo"></div>
</div>
<div class="upload-box" id="targetBox">
<h3>Target JSON</h3>
<div>Click or drop JSON file</div>
<input type="file" id="targetFile" accept=".json,application/json">
<div class="file-info" id="targetInfo"></div>
</div>
</div>
<div id="error" class="error"></div>
<div class="status" id="status">Load source and target JSON files to begin</div>
<div class="control-buttons">
<button class="btn" id="loadBtn" onclick="loadFiles()" disabled style="display:none">Load Files</button>
<button class="btn btn-secondary" id="resetBtn" onclick="resetAll()" style="display:none">Reset</button>
</div>
<div class="editor" id="editor">
<div class="editor-header">
<div>Source Text</div>
<div>Translation</div>
</div>
<div class="translation-list" id="translationList"></div>
<div class="action-buttons">
<button class="btn" id="saveSourceBtn" onclick="saveSource()" style="display:none">Save Source JSON</button>
<button class="btn" onclick="saveTarget()">Save Target JSON</button>
</div>
</div>
</div>
<script>
let sourceData=null,targetData=null,items=[],keyMap={}
let sourceFileName='source.json',targetFileName='translation.json'
let sourceChanged=false
let originalSourceValues={}
let originalTargetValues={}
let itemLocks={}

// Get references to upload boxes
const sourceBox=document.getElementById('sourceBox')
const targetBox=document.getElementById('targetBox')
const sourceFileInput=document.getElementById('sourceFile')
const targetFileInput=document.getElementById('targetFile')

// Setup drag and drop events
setupDragAndDrop(sourceBox,sourceFileInput)
setupDragAndDrop(targetBox,targetFileInput)

document.getElementById('sourceFile').addEventListener('change',e=>handleFile(e,'source'))
document.getElementById('targetFile').addEventListener('change',e=>handleFile(e,'target'))

function setupDragAndDrop(box,fileInput){
  box.addEventListener('dragover',e=>{
    e.preventDefault()
    box.classList.add('active')
    if(box===sourceBox){
      targetBox.classList.add('inactive')
    }else{
      sourceBox.classList.add('inactive')
    }
  })
  
  box.addEventListener('dragleave',e=>{
    e.preventDefault()
    if(!box.contains(e.relatedTarget)){
      box.classList.remove('active')
      sourceBox.classList.remove('inactive')
      targetBox.classList.remove('inactive')
    }
  })
  
  box.addEventListener('drop',e=>{
    e.preventDefault()
    box.classList.remove('active')
    sourceBox.classList.remove('inactive')
    targetBox.classList.remove('inactive')
    
    if(e.dataTransfer.files.length){
      fileInput.files=e.dataTransfer.files
      const event=new Event('change',{bubbles:true})
      fileInput.dispatchEvent(event)
    }
  })
}

function handleFile(e,type){
  let file=e.target.files[0]
  if(!file)return
  let reader=new FileReader()
  reader.onload=function(event){
    try{
      let text=event.target.result
      let data=JSON.parse(text)
      if(type==='source'){
        sourceData=data
        keyMap=createKeyMap(sourceData)
        sourceFileName=file.name
        document.getElementById('sourceInfo').textContent=`${file.name} (${Object.keys(keyMap).length} items)`
        
        // After loading source, highlight target box
        updateUploadBoxes('source')
      }else{
        targetData=data
        targetFileName=file.name
        document.getElementById('targetInfo').textContent=file.name
        
        // After loading target, highlight both boxes equally
        updateUploadBoxes('target')
      }
      document.getElementById('error').style.display='none'
      updateUIState()
    }catch(err){
      showError(`Invalid JSON in ${type}: ${err.message}`)
    }
  }
  reader.readAsText(file,'UTF-8')
}

function updateUploadBoxes(loadedType){
  // Reset all classes first
  sourceBox.classList.remove('active','inactive','compact')
  targetBox.classList.remove('active','inactive','compact')
  
  if(loadedType==='source'){
    // Source is loaded, highlight target as next step
    sourceBox.classList.add('compact')
    targetBox.classList.add('active')
  }else if(loadedType==='target'){
    // Both are loaded, make both compact
    if(sourceData){
      sourceBox.classList.add('compact')
      targetBox.classList.add('compact')
    }else{
      targetBox.classList.add('compact')
    }
  }
}

function updateUIState(){
  const loadBtn=document.getElementById('loadBtn')
  const resetBtn=document.getElementById('resetBtn')
  
  if(sourceData&&targetData){
    loadBtn.disabled=false
    loadBtn.style.display='inline-block'
    resetBtn.style.display='inline-block'
    updateStatus()
  }else if(sourceData){
    loadBtn.disabled=true
    loadBtn.style.display='none'
    resetBtn.style.display='inline-block'
    updateStatus()
  }else if(targetData){
    loadBtn.disabled=true
    loadBtn.style.display='none'
    resetBtn.style.display='inline-block'
    updateStatus()
  }else{
    loadBtn.disabled=true
    loadBtn.style.display='none'
    resetBtn.style.display='none'
    updateStatus()
  }
}

function createKeyMap(obj,path=''){
  let map={}
  for(let k in obj){
    if(!obj.hasOwnProperty(k))continue
    let cur=path?path+'.'+k:k
    let val=obj[k]
    if(val!==null&&typeof val==='object'){
      if(Array.isArray(val)){
        val.forEach((item,i)=>{
          let arrPath=cur+'['+i+']'
          if(typeof item==='string'){
            map[arrPath]='string'
          }else if(item!==null&&typeof item==='object'){
            Object.assign(map,createKeyMap(item,arrPath))
          }
        })
      }else{
        Object.assign(map,createKeyMap(val,cur))
      }
    }else{
      map[cur]=typeof val
    }
  }
  return map
}

function updateStatus(){
  let status=document.getElementById('status')
  if(!sourceData&&!targetData){
    status.textContent='Load source and target JSON files to begin'
  }else if(sourceData&&!targetData){
    status.textContent='Source loaded. Now load target JSON file.'
  }else if(!sourceData&&targetData){
    status.textContent='Target loaded. Now load source JSON file.'
  }else{
    status.textContent='Ready. Click "Load Files" to start editing.'
  }
}

function loadFiles(){
  if(!sourceData||!targetData){
    showError('Please load both files first')
    return
  }
  
  let targetMap=createKeyMap(targetData)
  let errors=[]
  
  for(let k in keyMap){
    if(targetMap[k]&&keyMap[k]!==targetMap[k]){
      errors.push(`Type mismatch at "${k}": source is ${keyMap[k]}, target is ${targetMap[k]}`)
    }
  }
  
  if(errors.length){
    showError(errors.join('<br>'))
    return
  }
  
  // Reset changed states when loading new files
  originalSourceValues={}
  originalTargetValues={}
  sourceChanged=false
  
  items=extractItems(sourceData)
  items.forEach(item=>{
    itemLocks[item.path]=true
    originalSourceValues[item.path]=getValue(sourceData,item.path)
    let targetVal=getValue(targetData,item.path)
    if(targetVal!==undefined){
      originalTargetValues[item.path]=targetVal
    }
  })
  renderEditor()
}

function extractItems(obj,path=''){
  let result=[]
  for(let k in obj){
    if(!obj.hasOwnProperty(k))continue
    let cur=path?path+'.'+k:k
    let val=obj[k]
    if(val!==null&&typeof val==='object'){
      if(Array.isArray(val)){
        val.forEach((item,i)=>{
          let arrPath=cur+'['+i+']'
          if(typeof item==='string'){
            result.push({path:arrPath,key:cur,value:item,type:'string',isArray:true,index:i})
          }else if(item!==null&&typeof item==='object'){
            result=result.concat(extractItems(item,arrPath))
          }
        })
      }else{
        result=result.concat(extractItems(val,cur))
      }
    }else{
      result.push({path:cur,key:cur,value:val,type:typeof val,isArray:false})
    }
  }
  return result
}

function getValue(obj,path){
  let parts=path.split(/[\.\[\]]+/).filter(p=>p!=='')
  let cur=obj
  for(let p of parts){
    if(cur===undefined||cur===null)return undefined
    cur=cur[p]
  }
  return cur
}

function renderEditor(){
  let list=document.getElementById('translationList')
  let html=''
  
  items.forEach((item,i)=>{
    let targetVal=getValue(targetData,item.path)
    let isLocked=itemLocks[item.path]
    let currentSourceValue=getValue(sourceData,item.path)
    let originalSourceValue=originalSourceValues[item.path]
    let originalTargetValue=originalTargetValues[item.path]
    
    // Check if value has changed from original
    let isSourceChanged=originalSourceValue!==undefined && 
                       currentSourceValue!==originalSourceValue
    let isTargetChanged=originalTargetValue!==undefined && 
                       targetVal!==originalTargetValue
    
    if(item.type==='string'){
      let sourceContent,sourceClasses
      if(isLocked){
        sourceClasses='source-text'
        if(isSourceChanged) sourceClasses+=' changed'
        sourceContent=`<div class="${sourceClasses}">${escapeHtml(currentSourceValue)}${item.isArray?`<span class="array-indicator">[${item.index}]</span>`:''}<div class="key-path">${item.path}</div></div>`
      }else{
        sourceClasses='source-input'
        if(isSourceChanged) sourceClasses+=' changed'
        sourceContent=`<textarea class="${sourceClasses}" data-path="${escapeHtml(item.path)}" oninput="updateSource(this,'${item.path}')">${escapeHtml(currentSourceValue)}</textarea><div class="key-path">${item.path}</div>`
      }
      
      let targetClasses='translation-input'
      if(isTargetChanged) targetClasses+=' changed'
      
      html+=`<div class="translation-item">
        <div class="source-area">
          ${sourceContent}
          <button class="lock-btn" title="${isLocked?'Unlock source':'Lock source'}" onclick="toggleSourceLock('${item.path}')">${isLocked?'ðŸ”’':'ðŸ”“'}</button>
        </div>
        <textarea class="${targetClasses}" data-path="${escapeHtml(item.path)}" placeholder="Translation..." oninput="updateTranslation(this,'${item.path}')">${targetVal!==undefined?escapeHtml(targetVal):''}</textarea>
      </div>`
    }else{
      html+=`<div class="translation-item">
        <div class="source-text">${currentSourceValue}<div class="key-path">${item.path} (${item.type})</div></div>
        <div style="padding:6px;color:#666;font-style:italic;font-size:13px">Not editable - ${item.type}</div>
      </div>`
    }
  })
  
  list.innerHTML=html
  document.getElementById('editor').style.display='block'
  document.getElementById('status').style.display='none'
  document.getElementById('loadBtn').style.display='none'
  document.getElementById('resetBtn').style.display='inline-block'
  
  // Make upload boxes even more compact when editor is open
  sourceBox.classList.add('compact')
  targetBox.classList.add('compact')
  
  autoExpandTextareas()
  
  // Update save source button visibility
  let hasSourceChanges=Object.keys(originalSourceValues).some(path=>{
    return getValue(sourceData,path)!==originalSourceValues[path]
  })
  document.getElementById('saveSourceBtn').style.display=hasSourceChanges?'inline-block':'none'
  sourceChanged=hasSourceChanges
}

function updateTranslation(textarea,path){
  let value=textarea.value
  setValue(targetData,path,value)
  
  // Update changed state by comparing with original
  let originalValue=originalTargetValues[path]
  let isChanged=originalValue!==undefined && value!==originalValue
  
  // Update textarea class
  if(isChanged){
    textarea.classList.add('changed')
  }else{
    textarea.classList.remove('changed')
  }
  
  autoExpand(textarea)
}

function updateSource(textarea,path){
  let value=textarea.value
  setValue(sourceData,path,value)
  
  // Update changed state by comparing with original
  let originalValue=originalSourceValues[path]
  let isChanged=originalValue!==undefined && value!==originalValue
  
  // Update textarea class
  if(isChanged){
    textarea.classList.add('changed')
  }else{
    textarea.classList.remove('changed')
  }
  
  // Check if any source has changed overall
  let hasSourceChanges=Object.keys(originalSourceValues).some(p=>{
    return getValue(sourceData,p)!==originalSourceValues[p]
  })
  
  sourceChanged=hasSourceChanges
  document.getElementById('saveSourceBtn').style.display=hasSourceChanges?'inline-block':'none'
  autoExpand(textarea)
}

function setValue(obj,path,value){
  let parts=path.split(/[\.\[\]]+/).filter(p=>p!=='')
  let cur=obj
  for(let i=0;i<parts.length-1;i++){
    let p=parts[i]
    if(cur[p]===undefined){
      cur[p]=/^\d+$/.test(parts[i+1])?[]:{}
    }
    cur=cur[p]
  }
  if(parts.length>0){
    cur[parts[parts.length-1]]=value
  }
}

function toggleSourceLock(path){
  itemLocks[path]=!itemLocks[path]
  renderEditor()
}

function autoExpandTextareas(){
  document.querySelectorAll('.source-input, .translation-input').forEach(t=>autoExpand(t))
}

function autoExpand(t){
  t.style.height='auto'
  t.style.height=(t.scrollHeight)+'px'
}

function saveSource(){
  if(!sourceData||!sourceChanged){
    showError('No changes to save')
    return
  }
  let jsonStr=JSON.stringify(sourceData,null,2)
  let blob=new Blob(['\uFEFF'+jsonStr],{type:'application/json;charset=utf-8'})
  let a=document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download=sourceFileName
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(a.href)
  
  // Update original values after saving
  items.forEach(item=>{
    originalSourceValues[item.path]=getValue(sourceData,item.path)
  })
  
  sourceChanged=false
  document.getElementById('saveSourceBtn').style.display='none'
  renderEditor()
}

function saveTarget(){
  if(!targetData){
    showError('No target data to save')
    return
  }
  let jsonStr=JSON.stringify(targetData,null,2)
  let blob=new Blob(['\uFEFF'+jsonStr],{type:'application/json;charset=utf-8'})
  let a=document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download=targetFileName
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(a.href)
  
  // Update original values after saving
  items.forEach(item=>{
    let targetVal=getValue(targetData,item.path)
    if(targetVal!==undefined){
      originalTargetValues[item.path]=targetVal
    }
  })
  
  renderEditor()
}

function resetAll(){
  // Clear all data
  sourceData=null
  targetData=null
  items=[]
  keyMap={}
  sourceChanged=false
  originalSourceValues={}
  originalTargetValues={}
  itemLocks={}
  
  // Clear file inputs
  document.getElementById('sourceFile').value=''
  document.getElementById('targetFile').value=''
  
  // Clear file info displays
  document.getElementById('sourceInfo').textContent=''
  document.getElementById('targetInfo').textContent=''
  
  // Reset upload boxes
  sourceBox.classList.remove('active','inactive','compact')
  targetBox.classList.remove('active','inactive','compact')
  
  // Hide editor and show status
  document.getElementById('editor').style.display='none'
  document.getElementById('status').style.display='block'
  document.getElementById('loadBtn').style.display='none'
  document.getElementById('resetBtn').style.display='none'
  document.getElementById('error').style.display='none'
  document.getElementById('saveSourceBtn').style.display='none'
  
  // Reset file names
  sourceFileName='source.json'
  targetFileName='translation.json'
  
  updateStatus()
}

function showError(msg){
  let e=document.getElementById('error')
  e.innerHTML=msg
  e.style.display='block'
}

function escapeHtml(t){
  if(t===null||t===undefined)return''
  return t.toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
}
</script>
