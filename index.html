<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;margin:20px}
.container{display:flex;flex-direction:column;gap:15px}
.upload-row{display:flex;gap:15px}
.reset-box{width:120px;border:2px dashed #ccc;padding:15px;text-align:center;min-height:100px;display:flex;flex-direction:column;justify-content:center;position:relative;transition:all 0.3s;background:#f8f9fa;border-radius:4px;cursor:pointer}
.reset-box:hover{background:#e9ecef;border-color:#6c757d}
.reset-box h3{margin:0 0 8px;font-size:16px;color:#495057}
.upload-box{flex:1;border:2px dashed #ccc;padding:15px;text-align:center;min-height:100px;display:flex;flex-direction:column;justify-content:center;position:relative;transition:all 0.3s}
.upload-box.compact{padding:8px !important;min-height:60px !important;border-width:1px !important}
.upload-box.disabled{border-color:#e0e0e0;background:#f5f5f5;cursor:not-allowed}
.upload-box.disabled h3,.upload-box.disabled div{color:#999}
.upload-box h3{margin:0 0 8px;font-size:16px}
.upload-box.compact h3{font-size:12px;margin:0 0 3px}
.upload-box.compact div{font-size:11px}
.upload-box.active{border-color:#0052cc;background:#f0f7ff}
.upload-box.inactive{opacity:0.5;filter:grayscale(50%)}
input[type="file"]{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer}
input[type="file"]:disabled{cursor:not-allowed}
.btn{background:#0052cc;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;margin:3px;font-size:13px}
.btn:disabled{background:#ccc}
.btn-secondary{background:#6c757d}
.error{color:#d00;background:#fee;padding:8px;border-radius:4px;display:none}
.warning{color:#856404;background:#fff3cd;padding:10px;border-radius:4px;display:none;margin:10px 0;border-left:4px solid #ffc107;max-height:400px;overflow-y:auto}
.editor{display:none;border:1px solid #ddd;border-radius:4px;position:relative}
.editor-header{display:grid;grid-template-columns:1fr 1fr;background:#f5f5f5;padding:8px;border-bottom:1px solid #ddd;font-size:13px}
.translation-list{}
.translation-item{display:grid;grid-template-columns:1fr 1fr;padding:10px;border-bottom:1px solid #eee;gap:10px;align-items:start}
.translation-item:nth-child(even){background:#fafafa}
.source-area{position:relative}
.source-text{padding:6px;border-left:3px solid #0052cc;background:#f0f7ff;border-radius:4px;white-space:pre-wrap;word-break:break-word;transition:border-color 0.2s;font-size:13px}
.source-text.changed{border-left-color:#ff9800 !important;background:#fff8e1}
.source-input{width:100%;padding:6px;border:1px solid #b3d4ff;border-radius:4px;resize:vertical;font-family:inherit;min-height:35px;box-sizing:border-box;font-size:13px}
.source-input.changed{border-color:#ff9800 !important;background:#fff8e1}
.lock-btn{position:absolute;top:6px;right:6px;background:none;border:none;cursor:pointer;font-size:12px;opacity:0.5;z-index:10;padding:2px}
.lock-btn:hover{opacity:1}
.translation-input{width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;resize:vertical;font-family:inherit;min-height:35px;transition:border-color 0.2s, background-color 0.2s;font-size:13px}
.translation-input:focus{outline:none;border-color:#0052cc;box-shadow:0 0 0 2px rgba(0,82,204,0.1)}
.translation-input.changed{border-color:#ff9800 !important;background:#fff8e1}
.key-path{font-family:monospace;font-size:11px;color:#666;padding:4px 0 0 0;margin-top:4px;border-top:1px dashed #ddd}
.array-indicator{color:#28a745;font-size:10px;margin-left:4px;background:#e8f5e9;padding:1px 4px;border-radius:8px}
.action-buttons{display:flex;gap:8px;justify-content:center;margin:15px 0;padding-top:15px;border-top:1px solid #e9ecef}
.status{text-align:center;padding:15px;color:#666}
.file-info{font-size:11px;color:#666;margin-top:5px}
.upload-box.compact .file-info{font-size:9px}
.control-buttons{display:flex;gap:8px;justify-content:center;align-items:center;margin:10px 0}
.scroll-buttons{position:fixed;bottom:20px;right:20px;display:flex;flex-direction:column;gap:6px;z-index:1000}
.scroll-btn{width:32px;height:32px;border-radius:50%;background:#6c757d;color:white;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;box-shadow:0 1px 4px rgba(0,0,0,0.15);transition:all 0.2s;position:relative}
.scroll-btn:hover{background:#5a6268;transform:scale(1.05)}
.scroll-btn:hover::after{content:attr(title);position:absolute;background:#333;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;white-space:nowrap;top:-35px;left:50%;transform:translateX(-50%);z-index:1001}
.scroll-btn:hover::before{content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#333}
.save-btn{width:32px;height:32px;border-radius:50%;background:#0052cc;color:white;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 1px 4px rgba(0,0,0,0.15);transition:all 0.2s;position:relative}
.save-btn:hover{background:#0041a8;transform:scale(1.05)}
.save-btn:hover::after{content:attr(title);position:absolute;background:#333;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;white-space:nowrap;top:-35px;left:50%;transform:translateX(-50%);z-index:1001}
.save-btn:hover::before{content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#333}
.save-btn.save-source{background:#28a745}
.save-btn.save-source:hover{background:#218838}
.load-btn-row{display:flex;justify-content:center;margin-top:10px}
.structure-info{padding:10px;background:#e8f4fd;border-radius:4px;margin-top:10px;font-size:12px;max-height:200px;overflow-y:auto}
.structure-info h4{margin:0 0 5px 0;color:#0052cc}
.structure-info ul{margin:0;padding-left:20px}
.structure-info li{margin:2px 0}
.toggle-list-btn{background:none;border:none;color:#0052cc;cursor:pointer;font-size:11px;padding:2px 5px;margin-left:5px;text-decoration:underline}
.toggle-list-btn:hover{color:#0041a8}
.key-count{font-weight:normal;font-size:11px;color:#6c757d;margin-left:5px}
.collapsible-section{margin-bottom:10px}
.collapsible-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;padding:5px;background:#e9ecef;border-radius:4px}
.collapsible-header:hover{background:#dee2e6}
.collapsible-content{max-height:0;overflow:hidden;transition:max-height 0.3s ease;background:#fff;border-radius:0 0 4px 4px}
.collapsible-content.expanded{max-height:200px;overflow-y:auto !important;padding:8px}
.collapsible-icon{transition:transform 0.3s}
.collapsible-icon.expanded{transform:rotate(180deg)}
.collapsible-content ul{margin:0;padding-left:20px;max-height:180px;overflow-y:auto}
.collapsible-content li{margin:3px 0;padding:3px;font-family:monospace;font-size:11px;word-break:break-all}
.collapsible-content code{background:#f1f1f1;padding:2px 4px;border-radius:3px;color:#333}
.reset-box.compact{padding:8px !important;min-height:60px !important;border-width:1px !important}
</style>
</head>
<body>
<div class="container">
<div class="upload-row">
<div class="reset-box" id="resetBox" onclick="resetAll()">
<h3>Reset</h3>
<div>Start over</div>
</div>
<div class="upload-box" id="sourceBox">
<h3>Source JSON</h3>
<div>Click or drop JSON file</div>
<input type="file" id="sourceFile" accept=".json,application/json">
<div class="file-info" id="sourceInfo"></div>
</div>
<div class="upload-box" id="targetBox">
<h3>Target JSON</h3>
<div>Click or drop JSON file</div>
<input type="file" id="targetFile" accept=".json,application/json">
<div class="file-info" id="targetInfo"></div>
</div>
</div>
<div id="error" class="error"></div>
<div id="warning" class="warning"></div>
<div class="status" id="status">Load source and target JSON files to begin</div>
<div class="load-btn-row">
<button class="btn" id="loadBtn" onclick="loadFiles()" disabled style="display:none">Load Files</button>
</div>
<div class="editor" id="editor">
<div class="editor-header">
<div>Source Text</div>
<div>Translation</div>
</div>
<div class="translation-list" id="translationList"></div>
</div>
<div class="scroll-buttons" id="scrollButtons" style="display:none">
<button class="save-btn save-source" id="floatSaveSourceBtn" onclick="saveSource()" title="Save Source JSON" style="display:none">ðŸ’¾</button>
<button class="save-btn" id="floatSaveTargetBtn" onclick="saveTarget()" title="Save Target JSON">ðŸ’¾</button>
<button class="scroll-btn" onclick="scrollToTop()" title="Scroll to top">â†‘</button>
<button class="scroll-btn" onclick="scrollToBottom()" title="Scroll to bottom">â†“</button>
</div>
</div>
<script>
let sourceData=null,targetData=null,items=[],keyMap={}
let sourceFileName='source.json',targetFileName='translation.json'
let sourceChanged=false
let originalSourceValues={}
let lastSavedSourceValues={}
let originalTargetValues={}
let itemLocks={}
let filteredTargetData=null
let missingKeys=[], extraKeys=[], typeMismatches=[]

// Get references to upload boxes
const sourceBox=document.getElementById('sourceBox')
const targetBox=document.getElementById('targetBox')
const sourceFileInput=document.getElementById('sourceFile')
const targetFileInput=document.getElementById('targetFile')

// Setup drag and drop events
setupDragAndDrop(sourceBox,sourceFileInput)
setupDragAndDrop(targetBox,targetFileInput)

document.getElementById('sourceFile').addEventListener('change',e=>handleFile(e,'source'))
document.getElementById('targetFile').addEventListener('change',e=>handleFile(e,'target'))

function setupDragAndDrop(box,fileInput){
  box.addEventListener('dragover',e=>{
    e.preventDefault()
    if(fileInput.disabled) return
    box.classList.add('active')
    if(box===sourceBox){
      targetBox.classList.add('inactive')
    }else{
      sourceBox.classList.add('inactive')
    }
  })
  
  box.addEventListener('dragleave',e=>{
    e.preventDefault()
    if(!box.contains(e.relatedTarget)){
      box.classList.remove('active')
      sourceBox.classList.remove('inactive')
      targetBox.classList.remove('inactive')
    }
  })
  
  box.addEventListener('drop',e=>{
    e.preventDefault()
    box.classList.remove('active')
    sourceBox.classList.remove('inactive')
    targetBox.classList.remove('inactive')
    
    if(fileInput.disabled) return
    
    if(e.dataTransfer.files.length){
      fileInput.files=e.dataTransfer.files
      const event=new Event('change',{bubbles:true})
      fileInput.dispatchEvent(event)
    }
  })
}

function handleFile(e,type){
  let file=e.target.files[0]
  if(!file)return
  
  // Prevent source file upload if editor is loaded
  if(type==='source' && document.getElementById('editor').style.display==='block'){
    e.target.value='' // Clear the file input
    showError('Source file cannot be changed while editing. Please reset first.')
    return
  }
  
  let reader=new FileReader()
  reader.onload=function(event){
    try{
      let text=event.target.result
      let data=JSON.parse(text)
      if(type==='source'){
        sourceData=data
        keyMap=createKeyMap(sourceData)
        sourceFileName=file.name
        document.getElementById('sourceInfo').textContent=`${file.name} (${Object.keys(keyMap).length} items)`
        
        // After loading source, update upload boxes
        updateUploadBoxes()
      }else{
        targetData=data
        targetFileName=file.name
        document.getElementById('targetInfo').textContent=file.name
        
        // After loading target, update upload boxes
        updateUploadBoxes()
      }
      document.getElementById('error').style.display='none'
      document.getElementById('warning').style.display='none'
      updateUIState()
    }catch(err){
      showError(`Invalid JSON in ${type}: ${err.message}`)
    }
  }
  reader.readAsText(file,'UTF-8')
}

function updateUploadBoxes(){
  const resetBox = document.getElementById('resetBox');
  
  // If editor is open, make ALL boxes super compact
  if(document.getElementById('editor').style.display==='block'){
    sourceBox.classList.add('compact');
    targetBox.classList.add('compact');
    resetBox.classList.add('compact');
    return;
  }
  
  // Reset all classes first
  sourceBox.classList.remove('active','inactive','compact');
  targetBox.classList.remove('active','inactive','compact');
  resetBox.classList.remove('compact');
  
  if(sourceData&&targetData){
    // Both files loaded, make them compact
    sourceBox.classList.add('compact');
    targetBox.classList.add('compact');
  }else if(sourceData){
    // Only source loaded
    sourceBox.classList.add('compact');
    targetBox.classList.add('active');
  }else if(targetData){
    // Only target loaded
    targetBox.classList.add('compact');
  }
}

function updateUIState(){
  const loadBtn=document.getElementById('loadBtn')
  
  if(sourceData&&targetData){
    loadBtn.disabled=false
    loadBtn.style.display='inline-block'
    updateStatus()
  }else if(sourceData){
    loadBtn.disabled=true
    loadBtn.style.display='none'
    updateStatus()
  }else if(targetData){
    loadBtn.disabled=true
    loadBtn.style.display='none'
    updateStatus()
  }else{
    loadBtn.disabled=true
    loadBtn.style.display='none'
    updateStatus()
  }
}

function createKeyMap(obj,path=''){
  let map={}
  for(let k in obj){
    if(!obj.hasOwnProperty(k))continue
    let cur=path?path+'.'+k:k
    let val=obj[k]
    if(val!==null&&typeof val==='object'){
      if(Array.isArray(val)){
        val.forEach((item,i)=>{
          let arrPath=cur+'['+i+']'
          if(typeof item==='string'){
            map[arrPath]='string'
          }else if(item!==null&&typeof item==='object'){
            Object.assign(map,createKeyMap(item,arrPath))
          }
        })
      }else{
        Object.assign(map,createKeyMap(val,cur))
      }
    }else{
      map[cur]=typeof val
    }
  }
  return map
}

function updateStatus(){
  let status=document.getElementById('status')
  if(!sourceData&&!targetData){
    status.textContent='Load source and target JSON files to begin'
  }else if(sourceData&&!targetData){
    status.textContent='Source loaded. Now load target JSON file.'
  }else if(!sourceData&&targetData){
    status.textContent='Target loaded. Now load source JSON file.'
  }else{
    status.textContent='Ready. Click "Load Files" to start editing.'
  }
}

function loadFiles(){
  if(!sourceData||!targetData){
    showError('Please load both files first')
    return
  }
  
  let targetMap=createKeyMap(targetData)
  missingKeys=[]
  extraKeys=[]
  typeMismatches=[]
  
  // Check for mismatches
  for(let k in keyMap){
    if(!targetMap.hasOwnProperty(k)){
      missingKeys.push(k)
    }else if(keyMap[k]!==targetMap[k]){
      typeMismatches.push(`"${k}": source is ${keyMap[k]}, target is ${targetMap[k]}`)
    }
  }
  
  // Check for extra keys in target
  for(let k in targetMap){
    if(!keyMap.hasOwnProperty(k)){
      extraKeys.push(k)
    }
  }
  
  // Build filtered target data that matches source structure
  filteredTargetData=JSON.parse(JSON.stringify(sourceData)) // Deep clone source structure
  
  // Populate filtered target with values from original target where keys match
  items=extractItems(sourceData)
  items.forEach(item=>{
    itemLocks[item.path]=true
    let sourceVal=getValue(sourceData,item.path)
    originalSourceValues[item.path]=sourceVal
    lastSavedSourceValues[item.path]=sourceVal
    
    // Get value from target if it exists and type matches
    let targetVal=getValue(targetData,item.path)
    if(targetVal!==undefined && typeof targetVal===keyMap[item.path]){
      setValue(filteredTargetData,item.path,targetVal)
      originalTargetValues[item.path]=targetVal
    }else{
      // Use source value for missing/mismatched keys
      setValue(filteredTargetData,item.path,sourceVal)
      originalTargetValues[item.path]=sourceVal
    }
  })
  
  // Replace targetData with filtered version
  targetData=filteredTargetData
  
  // Show warnings if there are mismatches
  updateWarningPanel()
  
  sourceChanged=false
  renderEditor()
}

function updateWarningPanel(){
  if(missingKeys.length===0 && extraKeys.length===0 && typeMismatches.length===0){
    document.getElementById('warning').style.display='none';
    return;
  }
  
  let warningMsg='';
  
  if(missingKeys.length>0){
    warningMsg+=`<div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapsible('missing')">
        <h4>Missing in target <span class="key-count">(${missingKeys.length})</span></h4>
        <span class="collapsible-icon" id="missingIcon">â–¼</span>
      </div>
      <div class="collapsible-content" id="missingContent">
        <ul>${missingKeys.map(k=>`<li><code>${k}</code></li>`).join('')}</ul>
      </div>
    </div>`;
  }
  
  if(extraKeys.length>0){
    warningMsg+=`<div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapsible('extra')">
        <h4>Extra in target <span class="key-count">(${extraKeys.length})</span></h4>
        <span class="collapsible-icon" id="extraIcon">â–¼</span>
      </div>
      <div class="collapsible-content" id="extraContent">
        <ul>${extraKeys.map(k=>`<li><code>${k}</code></li>`).join('')}</ul>
      </div>
    </div>`;
  }
  
  if(typeMismatches.length>0){
    warningMsg+=`<div class="collapsible-section">
      <div class="collapsible-header" onclick="toggleCollapsible('type')">
        <h4>Type mismatches <span class="key-count">(${typeMismatches.length})</span></h4>
        <span class="collapsible-icon" id="typeIcon">â–¼</span>
      </div>
      <div class="collapsible-content" id="typeContent">
        <ul>${typeMismatches.map(k=>`<li><code>${k}</code></li>`).join('')}</ul>
      </div>
    </div>`;
  }
  
  document.getElementById('warning').innerHTML=warningMsg;
  document.getElementById('warning').style.display='block';
}

function toggleCollapsible(type){
  const content=document.getElementById(type+'Content')
  const icon=document.getElementById(type+'Icon')
  
  if(content.classList.contains('expanded')){
    content.classList.remove('expanded')
    icon.classList.remove('expanded')
  }else{
    content.classList.add('expanded')
    icon.classList.add('expanded')
  }
}

function extractItems(obj,path=''){
  let result=[]
  for(let k in obj){
    if(!obj.hasOwnProperty(k))continue
    let cur=path?path+'.'+k:k
    let val=obj[k]
    if(val!==null&&typeof val==='object'){
      if(Array.isArray(val)){
        val.forEach((item,i)=>{
          let arrPath=cur+'['+i+']'
          if(typeof item==='string'){
            result.push({path:arrPath,key:cur,value:item,type:'string',isArray:true,index:i})
          }else if(item!==null&&typeof item==='object'){
            result=result.concat(extractItems(item,arrPath))
          }
        })
      }else{
        result=result.concat(extractItems(val,cur))
      }
    }else{
      result.push({path:cur,key:cur,value:val,type:typeof val,isArray:false})
    }
  }
  return result
}

function getValue(obj,path){
  let parts=path.split(/[\.\[\]]+/).filter(p=>p!=='')
  let cur=obj
  for(let p of parts){
    if(cur===undefined||cur===null)return undefined
    cur=cur[p]
  }
  return cur
}

function renderEditor(){
  let list=document.getElementById('translationList')
  let html=''
  
  let hasSourceChanges=false
  
  items.forEach((item,i)=>{
    let targetVal=getValue(targetData,item.path)
    let isLocked=itemLocks[item.path]
    let currentSourceValue=getValue(sourceData,item.path)
    let lastSavedValue=lastSavedSourceValues[item.path]
    let originalSourceValue=originalSourceValues[item.path]
    let originalTargetValue=originalTargetValues[item.path]
    
    // Check if value has changed from last saved (for Save button)
    let isSourceChangedForSave=lastSavedValue!==undefined && 
                       currentSourceValue!==lastSavedValue
    
    // Check if value has changed from original (for highlighting)
    let isSourceChangedForHighlight=originalSourceValue!==undefined && 
                       currentSourceValue!==originalSourceValue
    
    if(isSourceChangedForSave) hasSourceChanges=true
    
    let isTargetChanged=originalTargetValue!==undefined && 
                       targetVal!==originalTargetValue
    
    if(item.type==='string'){
      let sourceContent,sourceClasses
      if(isLocked){
        sourceClasses='source-text'
        if(isSourceChangedForHighlight) sourceClasses+=' changed'
        sourceContent=`<div class="${sourceClasses}">${escapeHtml(currentSourceValue)}${item.isArray?`<span class="array-indicator">[${item.index}]</span>`:''}<div class="key-path">${item.path}</div></div>`
      }else{
        sourceClasses='source-input'
        if(isSourceChangedForHighlight) sourceClasses+=' changed'
        sourceContent=`<textarea class="${sourceClasses}" data-path="${escapeHtml(item.path)}" oninput="updateSource(this,'${item.path}')">${escapeHtml(currentSourceValue)}</textarea><div class="key-path">${item.path}</div>`
      }
      
      let targetClasses='translation-input'
      if(isTargetChanged) targetClasses+=' changed'
      
      html+=`<div class="translation-item">
        <div class="source-area">
          ${sourceContent}
          <button class="lock-btn" title="${isLocked?'Unlock source':'Lock source'}" onclick="toggleSourceLock('${item.path}')">${isLocked?'ðŸ”’':'ðŸ”“'}</button>
        </div>
        <textarea class="${targetClasses}" data-path="${escapeHtml(item.path)}" placeholder="Translation..." oninput="updateTranslation(this,'${item.path}')">${targetVal!==undefined?escapeHtml(targetVal):''}</textarea>
      </div>`
    }else{
      html+=`<div class="translation-item">
        <div class="source-text">${currentSourceValue}<div class="key-path">${item.path} (${item.type})</div></div>
        <div style="padding:6px;color:#666;font-style:italic;font-size:13px">Not editable - ${item.type}</div>
      </div>`
    }
  })
  
  list.innerHTML=html
  document.getElementById('editor').style.display='block'
  document.getElementById('status').style.display='none'
  document.getElementById('loadBtn').style.display='none'
  document.getElementById('scrollButtons').style.display='flex'
  
  // Make upload boxes super compact when editor is open
  updateUploadBoxes()
  
  // Disable source file input and visually indicate it's disabled
  sourceFileInput.disabled=true
  sourceBox.classList.add('disabled')
  
  autoExpandTextareas()
  
  // Update save source button visibility
  document.getElementById('floatSaveSourceBtn').style.display=hasSourceChanges?'flex':'none'
  sourceChanged=hasSourceChanges
}

function updateTranslation(textarea,path){
  let value=textarea.value
  setValue(targetData,path,value)
  
  // Update changed state by comparing with original
  let originalValue=originalTargetValues[path]
  let isChanged=originalValue!==undefined && value!==originalValue
  
  // Update textarea class
  if(isChanged){
    textarea.classList.add('changed')
  }else{
    textarea.classList.remove('changed')
  }
  
  autoExpand(textarea)
}

function updateSource(textarea,path){
  let value=textarea.value
  setValue(sourceData,path,value)
  
  // Get current values for comparison
  let currentValue=getValue(sourceData,path)
  let lastSavedValue=lastSavedSourceValues[path]
  let originalValue=originalSourceValues[path]
  
  // Update changed state for highlighting (compare with original)
  let isChangedForHighlight=originalValue!==undefined && currentValue!==originalValue
  
  // Update changed state for save button (compare with last saved)
  let isChangedForSave=lastSavedValue!==undefined && currentValue!==lastSavedValue
  
  // Update textarea class for highlighting
  if(isChangedForHighlight){
    textarea.classList.add('changed')
  }else{
    textarea.classList.remove('changed')
  }
  
  // Check if any source has changed overall (for Save button)
  let hasSourceChanges=false
  items.forEach(item=>{
    let currentValue=getValue(sourceData,item.path)
    let lastSavedValue=lastSavedSourceValues[item.path]
    if(lastSavedValue!==undefined && currentValue!==lastSavedValue){
      hasSourceChanges=true
    }
  })
  
  sourceChanged=hasSourceChanges
  document.getElementById('floatSaveSourceBtn').style.display=hasSourceChanges?'flex':'none'
  autoExpand(textarea)
}

function setValue(obj,path,value){
  let parts=path.split(/[\.\[\]]+/).filter(p=>p!=='')
  let cur=obj
  for(let i=0;i<parts.length-1;i++){
    let p=parts[i]
    if(cur[p]===undefined){
      cur[p]=/^\d+$/.test(parts[i+1])?[]:{}
    }
    cur=cur[p]
  }
  if(parts.length>0){
    cur[parts[parts.length-1]]=value
  }
}

function toggleSourceLock(path){
  itemLocks[path]=!itemLocks[path]
  renderEditor()
}

function autoExpandTextareas(){
  document.querySelectorAll('.source-input, .translation-input').forEach(t=>autoExpand(t))
}

function autoExpand(t){
  t.style.height='auto'
  t.style.height=(t.scrollHeight)+'px'
}

function scrollToTop(){
  const editor=document.getElementById('editor')
  editor.scrollIntoView({behavior:'smooth'})
}

function scrollToBottom(){
  const editor=document.getElementById('editor')
  const translationList=document.getElementById('translationList')
  const lastItem=translationList.lastElementChild
  
  if(lastItem){
    lastItem.scrollIntoView({behavior:'smooth',block:'end'})
  }else{
    editor.scrollIntoView({behavior:'smooth',block:'end'})
  }
}

function saveSource(){
  if(!sourceData||!sourceChanged){
    showError('No changes to save')
    return
  }
  let jsonStr=JSON.stringify(sourceData,null,2)
  let blob=new Blob(['\uFEFF'+jsonStr],{type:'application/json;charset=utf-8'})
  let a=document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download=sourceFileName
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(a.href)
  
  // Lock all source fields
  items.forEach(item=>{
    itemLocks[item.path]=true
  })
  
  // Update last saved values (for Save button logic)
  items.forEach(item=>{
    lastSavedSourceValues[item.path]=getValue(sourceData,item.path)
  })
  
  sourceChanged=false
  document.getElementById('floatSaveSourceBtn').style.display='none'
  renderEditor()
}

function saveTarget(){
  if(!targetData){
    showError('No target data to save')
    return
  }
  
  // Save target in the structure of source JSON (which is what targetData now is)
  let jsonStr=JSON.stringify(targetData,null,2)
  let blob=new Blob(['\uFEFF'+jsonStr],{type:'application/json;charset=utf-8'})
  let a=document.createElement('a')
  a.href=URL.createObjectURL(blob)
  a.download=targetFileName
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(a.href)
  
  // Update original values after saving (this removes orange highlights)
  items.forEach(item=>{
    let targetVal=getValue(targetData,item.path)
    if(targetVal!==undefined){
      originalTargetValues[item.path]=targetVal
    }
  })
  
  renderEditor()
}

function resetAll(){
  // Reset all data
  sourceData=null
  targetData=null
  filteredTargetData=null
  items=[]
  keyMap={}
  sourceChanged=false
  originalSourceValues={}
  lastSavedSourceValues={}
  originalTargetValues={}
  itemLocks={}
  missingKeys=[]
  extraKeys=[]
  typeMismatches=[]
  
  // Clear file inputs
  document.getElementById('sourceFile').value=''
  document.getElementById('targetFile').value=''
  
  // Enable source file input
  sourceFileInput.disabled=false
  
  // Clear file info displays
  document.getElementById('sourceInfo').textContent=''
  document.getElementById('targetInfo').textContent=''
  
  // Reset upload boxes to full size
  sourceBox.classList.remove('active','inactive','compact','disabled')
  targetBox.classList.remove('active','inactive','compact','disabled')
  document.getElementById('resetBox').classList.remove('compact')
  
  // Hide editor and show status
  document.getElementById('editor').style.display='none'
  document.getElementById('status').style.display='block'
  document.getElementById('loadBtn').style.display='none'
  document.getElementById('scrollButtons').style.display='none'
  document.getElementById('error').style.display='none'
  document.getElementById('warning').style.display='none'
  document.getElementById('floatSaveSourceBtn').style.display='none'
  
  // Reset file names
  sourceFileName='source.json'
  targetFileName='translation.json'
  
  updateStatus()
}

function showError(msg){
  let e=document.getElementById('error')
  e.innerHTML=msg
  e.style.display='block'
  document.getElementById('warning').style.display='none'
}

function escapeHtml(t){
  if(t===null||t===undefined)return''
  return t.toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))
}
</script>
</body>
</html>
